"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeEnvConfiguration=void 0;var _nodeFs=require("node:fs"),_nodePath=require("node:path"),_lib=require("./lib"),_NginxConfiguration=require("./NginxConfiguration"),_enums=require("../enums"),_tools=require("./tools");function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);n=n.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var watchFileListener=function n(e,t,o){var o=o||{},r=o.outDir,i=o.dir,u=o.content,c=o.nginxConfig,s=o.nginx,l=o.devOutDir;if(console.log("⚡️ ".concat(_tools.defaultOutName," watch:"),"".concat((0,_nodePath.resolve)(r)," file has changed ⚡️")),e.mtime!==t.mtime)try{(0,_nodeFs.statSync)((0,_nodePath.resolve)(i)).isDirectory()?((0,_tools.createFile)(i,u),null!=c&&c.isExp&&(0,_NginxConfiguration.outputNginx)(c,s)):((0,_nodeFs.statSync)((0,_nodePath.resolve)(l))||(0,_nodeFs.unlinkSync)((0,_nodePath.resolve)(l)),null!=c&&c.isExp&&(0,_NginxConfiguration.outputNginx)(c,s),(0,_nodeFs.unwatchFile)((0,_nodePath.resolve)(r),function(e,t){n(e,t,{outDir:r,dir:i,content:u,nginxConfig:c,nginx:s,devOutDir:l})}),console.log("⚡️ ".concat(_tools.defaultOutName," done ⚡️")))}catch(e){(0,_tools.createFile)(i,u),null!=c&&c.isExp&&(0,_NginxConfiguration.outputNginx)(c,s)}},watcherOutDir=function t(o,r){var i=r.dir,u=r.content,c=r.nginxConfig,s=r.nginx,l=r.devOutDir;(0,_nodeFs.readdir)((0,_nodePath.resolve)(o),function(e){if(e){try{var n=(null==o?void 0:o.split("/"))||[];n.map(function(e,t){return 0<t?"".concat(n[t-1],"/").concat(e):e}).forEach(function(e){return(0,_nodeFs.mkdirSync)(e)})}catch(e){console.error(e)}t(o,r)}else(0,_tools.createFile)(i,u),null!=c&&c.isExp&&(0,_NginxConfiguration.outputNginx)(c,s),(0,_nodeFs.watchFile)((0,_nodePath.resolve)(o),function(e,t){watchFileListener(e,t,{outDir:o,dir:i,content:u,nginxConfig:c,nginx:s,devOutDir:l})})})},NodeEnvConfiguration=exports.NodeEnvConfiguration=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"js",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"dist",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:_enums.DEFAULT_CONFIGURATION,n=(console.log("⚡️ ".concat(_tools.defaultOutName," start ⚡️")),(0,_tools.initConfiguration)(e,t,n)),o=n.path,r=n.ENV,i=n.devOutDir,u=n.isPros,c=n.workerSource,s=n.nginx,l=n.outConfig,n=n.conetnt,a=(0,_tools.initOutDir)(e);return(0,_lib.isObjEmpty)(c)&&((0,_nodeFs.existsSync)((0,_nodePath.resolve)(o||""))||(0,_nodeFs.mkdirSync)((0,_nodePath.resolve)(o||"")),(0,_nodeFs.writeFileSync)(i,n),u)&&(delete c.proxy,o=_objectSpread({ENV:r,CONFIG_URL:a},c),n="window.envConf = ".concat(o),watcherOutDir(t,{dir:"".concat(t,"/").concat(a),content:"json"!==e?n:JSON.stringify(o),nginxConfig:{},nginx:s,devOutDir:i})),l};