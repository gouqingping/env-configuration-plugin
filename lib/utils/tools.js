"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.workerEach=exports.isTs=exports.initOutDir=exports.initOutConfig=exports.initInputDir=exports.initConfiguration=exports.getWorkerProvider=exports.exps=exports.defaultOutName=exports.defaultExpName=exports.createFile=exports.createContent=void 0;var _lib=require("./lib"),_enums=require("../enums"),_fs=require("fs"),_path=require("path"),_excluded=["nginx"];function _objectWithoutProperties(t,r){if(null==t)return{};var e,n=_objectWithoutPropertiesLoose(t,r);if(Object.getOwnPropertySymbols)for(var o=Object.getOwnPropertySymbols(t),i=0;i<o.length;i++)e=o[i],0<=r.indexOf(e)||Object.prototype.propertyIsEnumerable.call(t,e)&&(n[e]=t[e]);return n}function _objectWithoutPropertiesLoose(t,r){if(null==t)return{};for(var e,n={},o=Object.keys(t),i=0;i<o.length;i++)e=o[i],0<=r.indexOf(e)||(n[e]=t[e]);return n}function _slicedToArray(t,r){return _arrayWithHoles(t)||_iterableToArrayLimit(t,r)||_unsupportedIterableToArray(t,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,r){var e;if(t)return"string"==typeof t?_arrayLikeToArray(t,r):"Map"===(e="Object"===(e=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:e)||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_arrayLikeToArray(t,r):void 0}function _arrayLikeToArray(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=new Array(r);e<r;e++)n[e]=t[e];return n}function _iterableToArrayLimit(t,r){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var n,o,i,a,c=[],u=!0,s=!1;try{if(i=(e=e.call(t)).next,0===r){if(Object(e)!==e)return;u=!1}else for(;!(u=(n=i.call(e)).done)&&(c.push(n.value),c.length!==r);u=!0);}catch(t){s=!0,o=t}finally{try{if(!u&&null!=e.return&&(a=e.return(),Object(a)!==a))return}finally{if(s)throw o}}return c}}function _arrayWithHoles(t){if(Array.isArray(t))return t}var defaultOutName=exports.defaultOutName=_enums.DEFAULT_OUT_FILENAME,defaultExpName=exports.defaultExpName=_enums.DEFAULT_OUT_FILENAME,exps=exports.exps=["proxy"],initInputDir=exports.initInputDir=function(t){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"js";return"".concat(t,"/").concat(defaultExpName,".").concat(r)},initOutDir=exports.initOutDir=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"js";return"".concat(defaultOutName,".config.").concat(t)},isTs=exports.isTs=function(){return["tsx","ts"].includes(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"js")},getWorkerProvider=exports.getWorkerProvider=function(t,r){t=t.split("[[").filter(function(t){return t.startsWith("".concat(r,"]]"))}),t=_slicedToArray(((null==t?void 0:t[0])||"").split(/]]/),2),t[0],t=t[1];return(0,_lib.createWorker)(t)},initOutConfig=exports.initOutConfig=function(t,r){var e=r||{},n=e.outType,o=e.outDir,i=e.path,a=e.inputType,c=e.isPro,e=(0,_lib.getProxy)((null==t?void 0:t.proxy)||{}),u=e.proxys,e=e.nginx,r=r?{name:defaultOutName,source:t,config:function(){return{type:n,outDir:o,path:i,inputType:a,isPro:c}}}:{};return{proxy:(0,_lib.createProxy)(u),plugin:r,nginx:e}},createContent=exports.createContent=function(o,i){var a,c="{\r\n ";return(0,_lib.isObject)(o)&&(a=Object.keys(o)).forEach(function(t,r){var e=JSON.stringify(o[t]),r=a.length-1===r,n=(0,_lib.isString)(o[t])?'"'.concat(o[t],'"'):o[t],e=(0,_lib.isObject)(o[t])?e:n;t&&e&&(n=Array.isArray(o[t])?"[]":'""',n=(0,_lib.isObject)(o[t])?"{}":n,n=i&&0===(0,_lib.isIPURL)(e)?n:e,e=r?"":",\r\n",c="".concat(c,"  ").concat(t,":").concat(n).concat(e," "))}),c},workerEach=exports.workerEach=function(t,n,r){var e=r.env,o=r.pro,r=r.outFile,i=t?":string":"",a=t?":AnyObject":"",c="export const ENV".concat(i,' = "').concat(e,'";\r\nexport const CONFIG_URL').concat(i,' = "').concat(r,'";\r\n'),u="ENV,CONFIG_URL,",s=(t&&(c="interface AnyObject { [k: string]: any }\r\n".concat(c,"\r\n")),Object.keys(n));return s.forEach(function(t,r){var e,r=s.length-1===r;n[t]&&!exps.includes(t)&&(e=createContent(n[t],o),c="".concat(c,"export const ").concat(t).concat(a," = ").concat(e,"\r\n};\r\n"),u="".concat(u).concat(t).concat(r?"":","))}),"".concat(c,"\r\nexport default {").concat(u.replace(/,$/,""),"}")},createFile=exports.createFile=function(t,r){return(0,_fs.writeFileSync)((0,_path.resolve)(t),r)},initConfiguration=exports.initConfiguration=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"js",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"dist",e=2<arguments.length?arguments[2]:void 0,n=(0,_lib.loadConf)().NODE_ENV,o=e.path,i=e.inputType,a=e.isPro,e=e.inputDir,e="".concat(e).concat(e.endsWith("/")?"":"/"),e="".concat(e||"/").concat(defaultOutName),e=(0,_fs.readFileSync)(e,"utf-8"),c=initInputDir(o||"src",i),u=isTs(i),a=a||(0,_lib.isProd)(n),e=getWorkerProvider(e,n),r=initOutConfig(e,{outType:t,outDir:r,path:o,inputType:i,isPro:a}),i=r.nginx,r=_objectWithoutProperties(r,_excluded),t=initOutDir(t);return{path:o,ENV:n,devOutDir:c,isOutTs:u,isPros:a,workerSource:e,nginx:i,outConfig:r,conetnt:workerEach(u,e,{env:n,pro:a,outFile:t}),outFileName:t}};